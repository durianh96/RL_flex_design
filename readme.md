
Flexibility Design with Neural Reinforcement Learning  
==================================

## Setup 
This code is based on [the spinningup project from OpenAi](https://github.com/openai/spinningup). 
Create a conda environment and 
- [install spinningup](https://spinningup.openai.com/en/latest/user/installation.html). Note that "MuJoCo" is not needed. 
- install Gurobi. Gurobi is needed by the Flexibility Environment 
to evaluate rewards by solving linear programming problems. 
- install tensorboard if it is not installed during spinningup setup. 
- install networkx and pyglet.

```commandline


```

## Run the codes
The entry point of running the RL training using FlexibilityEnv is run_flexibility.py under /spinningup/spinup. 
It allows multiple experiments to be run using ExperimentGrid, a tool from OpenAI. 
For example, below snipet allows four experiments to be run sequentially, each with a different target_arcs, 27, 29, 31, 33. 

```commandline
python -m spinup.run_flexibility 
    --algo ppo  
    --env_name Flexibility8x16_SP50-v3 
    --exp_name Flexibility8x16_SP50_PPO_CH1024-128_ENV3_JG  
    --cpu 8 
    --epochs 400  
    --save_freq 10  
    --custom_h 1024-128 
    --env_version 3 
    --env_input inputJG_m8n16_cv0.4.pkl 
    --target_arcs 27 29 31 33
```

Bash scripts can also be created to invoke experiments by calling run_flexibility.py. 
Check out one of the examples "run_experiments...." under /spinningup. 

Below is an example of running a bash script from command line. 
```
(spinningup) user@ubuntu:~/git/RL_flex_design$ ./run_experiments_CH1024-128_ENV3_input_ran10x10a_cv0.8.sh
```

## Algorithm 
PPO algorithm is used in our RL training. We modified the ppo.py file under /spinningup/spinup/algos/ppo/ from spinningup to run our Flexibility Env. 
ppo.py runs one experiment at a time. If multiple experiments are specified in run_flexibility.py, 
they are passed into ppo.py sequentially. 

Log files are saved in the /spinningup/data directory, unless otherwise specified in the user_config.py file. 

## Neural Net Architecture 
A three layer multi-layer perceptron (MLP) is used for both actor and critic networks. 
core.py file in the ppo directory specify the actor and critic networks. 
We modified core.py to add temperature into the policy action. 
The size of the two hidden layers of the 3-layer MLP can be specified using `--custom_h`, e.g., `--custom_h 1024-128`. 

## Monitor the training progress 
Tensorboard is used to monitor the training progress. 
If tensorboard is installed, launch it from command line under the same conda environment by running 
```commandline
tensorboard --logdir=data
```

## Collect genereated structures 
Evaluation can be carried during training which can be specified through a combination of 
e.g., `--save_frequency 10` and `--do_checkpoint_eval`. Trained models at each checkpoint is 
saved into a "simple_saveN" (N is the epoch number) directory under the log directory of this experiment under data. 
"simple_save999999" directory saves the best model so far, and also the best structure generated by the best model. 
After the experiments are finished, we can run "collect_best_structure.py" file under /spinningup/best_structures
to collect the best structures generated during training. To identify best structures from which
experiments to be collected, use "exp_settings.py" file. 

## Directory structure 
is mostly unchanged from spinningup. A few changes are made as listed below: 
- ppo.py has been modified and is the main algorithm we use. vpg.py is also modified, but is not completed yet. 
- Subdirectory /spinningup/spinup/FlexibilityEnv is created to keep FlexibilityEnv.py, which is a custom Flexibility Environment 
that is created to follow gym environment format. 
- Subdirectory /spinningup/spinup/FlexibilityEnv_input is created to keep input files which specify settings for FlexibilityEnv objects for different experiments. 
- run_flexibility.py is created to run rl games with the FlexibilityEnv. It is modified based on run.py
- A few utils files are created under /spinningup/spinup/utils 
- Bash scripts are created under /spinningup to load multiple experiments 
- /spnningup/best_structure directory is created to collect best structures generated during training. 

